{"version":3,"file":"main.js","sourceRoot":"","sources":["../../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\r\n// Licensed under the MIT license.\r\n\r\nimport { shutdownAzureMonitor as distroShutdownAzureMonitor, useAzureMonitor as distroUseAzureMonitor } from \"@azure/monitor-opentelemetry\";\r\nimport { ProxyTracerProvider, diag, metrics, trace } from \"@opentelemetry/api\";\r\nimport { logs } from \"@opentelemetry/api-logs\";\r\nimport { MeterProvider } from \"@opentelemetry/sdk-metrics\";\r\nimport { BatchLogRecordProcessor, LoggerProvider } from \"@opentelemetry/sdk-logs\";\r\nimport { BasicTracerProvider, BatchSpanProcessor, SpanProcessor } from \"@opentelemetry/sdk-trace-node\";\r\nimport { OTLPLogExporter } from \"@opentelemetry/exporter-logs-otlp-http\";\r\nimport { OTLPTraceExporter } from \"@opentelemetry/exporter-trace-otlp-http\";\r\nimport { AutoCollectLogs } from \"./logs/autoCollectLogs\";\r\nimport { AutoCollectExceptions } from \"./logs/exceptions\";\r\nimport { AzureMonitorOpenTelemetryOptions } from \"./types\";\r\nimport { ApplicationInsightsConfig } from \"./shared/configuration/config\";\r\nimport { LogApi } from \"./shim/logsApi\";\r\nimport { StatsbeatFeature } from \"./shim/types\";\r\nimport { StatsbeatFeaturesManager } from \"./shared/util/statsbeatFeaturesManager\";\r\n\r\nlet autoCollectLogs: AutoCollectLogs;\r\nlet exceptions: AutoCollectExceptions;\r\n\r\n/**\r\n * Initialize Azure Monitor\r\n * @param options Configuration\r\n */\r\nexport function useAzureMonitor(options?: AzureMonitorOpenTelemetryOptions) {\r\n    // Initialize statsbeat features with default values and enable SHIM feature\r\n    StatsbeatFeaturesManager.getInstance().initialize();\r\n    StatsbeatFeaturesManager.getInstance().enableFeature(StatsbeatFeature.SHIM);\r\n    \r\n    // Allows for full filtering of dependency/request spans\r\n    const internalConfig = new ApplicationInsightsConfig(options);\r\n    \r\n    // Add OTLP exporters if configured\r\n    const otlpSpanProcessor = _getOtlpSpanExporter(internalConfig);\r\n    const otlpLogProcessor = _getOtlpLogExporter(internalConfig);\r\n    \r\n    // Ensure options object exists and add processors\r\n    if (!options) {\r\n        options = {};\r\n    }\r\n    \r\n    if (otlpSpanProcessor) {\r\n        if (!options.spanProcessors) {\r\n            options.spanProcessors = [];\r\n        }\r\n        options.spanProcessors.push(otlpSpanProcessor);\r\n    }\r\n    \r\n    if (otlpLogProcessor) {\r\n        if (!options.logRecordProcessors) {\r\n            options.logRecordProcessors = [];\r\n        }\r\n        options.logRecordProcessors.push(otlpLogProcessor);\r\n    }\r\n    \r\n    distroUseAzureMonitor(options);\r\n    const logApi = new LogApi(logs.getLogger(\"ApplicationInsightsLogger\"));\r\n    autoCollectLogs = new AutoCollectLogs();\r\n    if (internalConfig.enableAutoCollectExceptions) {\r\n        exceptions = new AutoCollectExceptions(logApi);\r\n    }\r\n    autoCollectLogs.enable(internalConfig.instrumentationOptions);\r\n}\r\n\r\n/**\r\n* Shutdown Azure Monitor\r\n*/\r\nexport async function shutdownAzureMonitor() {\r\n    await distroShutdownAzureMonitor();\r\n    autoCollectLogs.shutdown();\r\n    exceptions?.shutdown();\r\n}\r\n\r\n/**\r\n * Try to send all queued telemetry if present.\r\n */\r\nexport async function flushAzureMonitor() {\r\n    try {\r\n        await (metrics.getMeterProvider() as MeterProvider).forceFlush();\r\n        await (((trace.getTracerProvider() as ProxyTracerProvider).getDelegate()) as BasicTracerProvider).forceFlush();\r\n        await (logs.getLoggerProvider() as LoggerProvider).forceFlush();\r\n    } catch (err) {\r\n        diag.error(\"Failed to flush telemetry\", err);\r\n    }\r\n}\r\n\r\nfunction _getOtlpSpanExporter(internalConfig: ApplicationInsightsConfig): SpanProcessor {\r\n    if (internalConfig.otlpTraceExporterConfig?.enabled) {\r\n        const otlpTraceExporter = new OTLPTraceExporter(internalConfig.otlpTraceExporterConfig);\r\n        const otlpSpanProcessor = new BatchSpanProcessor(otlpTraceExporter);\r\n        return otlpSpanProcessor;\r\n    }\r\n}\r\n\r\nfunction _getOtlpLogExporter(internalConfig: ApplicationInsightsConfig): BatchLogRecordProcessor {\r\n    if (internalConfig.otlpLogExporterConfig?.enabled) {\r\n        const otlpLogExporter = new OTLPLogExporter(internalConfig.otlpLogExporterConfig);\r\n        const otlpLogProcessor = new BatchLogRecordProcessor(otlpLogExporter);\r\n        return otlpLogProcessor;\r\n    }\r\n}\r\n"]}